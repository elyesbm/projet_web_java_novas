{% extends 'admin/base_admin.html.twig' %}

{% block title %}{{ mode|default('create') == 'create' ? 'Nouvel' : 'Modifier' }} article - NOVAS Admin{% endblock %}
{% block page_title %}{{ mode|default('create') == 'create' ? 'Nouvel article' : 'Modifier l\'article' }}{% endblock %}
{% block page_subtitle %}{{ mode|default('create') == 'create' ? 'Ajouter un article au marketplace' : 'Modifier les informations' }}{% endblock %}

{% block body %}
<div class="max-w-5xl mx-auto">
    <form id="admin-marketplace-form" method="post" enctype="multipart/form-data" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        {# Main Form #}
        <div class="lg:col-span-2 space-y-6">
            <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-soft border border-slate-100 dark:border-slate-700 p-6">
                <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-6">Informations de l'article</h3>
                
                <div class="space-y-2 mb-6">
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Titre <span class="text-rose-500">*</span></label>
                    <input
                        type="text"
                        name="titre"
                        value="{{ article is defined and article ? article.titreArticle : '' }}"
                        class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 focus:ring-2 focus:ring-rose-500 text-lg"
                        placeholder="ex: MacBook Pro M2"
                    >
                </div>

                <div class="space-y-2 mb-6">
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Description <span class="text-rose-500">*</span></label>
                    <textarea
                        name="contenu"
                        rows="5"
                        class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 focus:ring-2 focus:ring-rose-500 resize-none"
                        placeholder="Décrivez votre article..."
                    >{{ article is defined and article ? article.contenueArticle : '' }}</textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Prix (DT) <span class="text-rose-500">*</span></label>
                        <input
                            type="text"
                            name="prix"
                            value="{{ article is defined and article and article.prixArticle is not null ? article.prixArticle : '' }}"
                            class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 focus:ring-2 focus:ring-rose-500 text-2xl font-bold text-rose-600"
                            placeholder="0.00"
                        >
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Catégorie <span class="text-rose-500">*</span></label>
                        <select
                            name="categorie"
                            class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 focus:ring-2 focus:ring-rose-500"
                        >
                            <option value="">Sélectionner une catégorie</option>
                            {% if categories is defined %}
                                {% for cat in categories %}
                                    <option value="{{ cat.id }}" {% if article is defined and article and article.categorie and article.categorie.id == cat.id %}selected{% endif %}>
                                        {{ cat.nom }}
                                    </option>
                                {% endfor %}
                            {% endif %}
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Type</label>
                        {% set currentType = article is defined and article and article.typeArticle ? article.typeArticle : 'academic' %}
                        <select
                            name="type"
                            class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 focus:ring-2 focus:ring-rose-500"
                        >
                            <option value="academic" {{ currentType == 'academic' ? 'selected' }}>Academic</option>
                            <option value="commercial" {{ currentType == 'commercial' ? 'selected' }}>Commercial</option>
                            <option value="service" {{ currentType == 'service' ? 'selected' }}>Service</option>
                            <option value="other" {{ currentType == 'other' ? 'selected' }}>Autre</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Statut</label>
                        {% set currentStatut = article is defined and article and article.statutArticle ? article.statutArticle : 'disponible' %}
                        <select
                            name="statut"
                            class="w-full px-4 py-3 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 focus:ring-2 focus:ring-rose-500"
                        >
                            <option value="disponible" {{ currentStatut == 'disponible' ? 'selected' }}>Disponible</option>
                            <option value="reserve" {{ currentStatut == 'reserve' ? 'selected' }}>Réservé</option>
                            <option value="vendu" {{ currentStatut == 'vendu' ? 'selected' }}>Vendu</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Image (depuis votre PC)</label>
                        <input
                            type="file"
                            name="image"
                            accept="image/*"
                            class="w-full px-3 py-2.5 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-sm"
                        >
                    </div>
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">Image (nom de fichier / URL relative)</label>
                        <input
                            type="text"
                            name="image_article"
                            value="{{ article is defined and article and article.imageArticle ? article.imageArticle : '' }}"
                            class="w-full px-4 py-2.5 rounded-xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 focus:ring-2 focus:ring-rose-500 text-sm"
                            placeholder="ex: macbook.jpg"
                        >
                    </div>
                </div>
            </div>

            <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-soft border border-slate-100 dark:border-slate-700 p-6">
                <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-6">Photos</h3>
                <div class="aspect-[4/3] rounded-xl bg-slate-100 dark:bg-slate-700 mb-3 flex items-center justify-center text-slate-400 overflow-hidden">
                    {% if article is defined and article and article.imageArticle %}
                        <img
                            src="{{ asset('images/' ~ article.imageArticle) }}"
                            alt="Image article"
                            class="w-full h-full object-cover"
                            onerror="this.style.display='none';"
                        >
                        <div class="absolute opacity-0 pointer-events-none">.</div>
                    {% else %}
                        <i data-lucide="image" class="w-8 h-8"></i>
                    {% endif %}
                </div>
                <p class="text-xs text-slate-500 mt-1">
                    Vous pouvez soit sélectionner une image depuis votre PC, soit saisir directement le nom de fichier stocké dans <code>public/images</code>.
                </p>
            </div>
        </div>

        {# Sidebar Preview + actions persistantes #}
        <div class="space-y-6">
            <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-soft border border-slate-100 dark:border-slate-700 p-6 sticky top-6">
                <h3 class="text-lg font-semibold text-slate-900 dark:text-white mb-4">Aperçu</h3>
                <div class="aspect-[4/3] rounded-xl bg-slate-100 dark:bg-slate-700 mb-4 flex items-center justify-center text-slate-400 overflow-hidden">
                    {% if article is defined and article and article.imageArticle %}
                        <img
                            src="{{ asset('images/' ~ article.imageArticle) }}"
                            alt="Image article"
                            class="w-full h-full object-cover"
                            onerror="this.style.display='none';"
                        >
                        <i data-lucide="image" class="w-12 h-12"></i>
                    {% else %}
                        <i data-lucide="image" class="w-12 h-12"></i>
                    {% endif %}
                </div>
                <h4 class="font-bold text-slate-900 dark:text-white mb-1">
                    {{ article is defined and article and article.titreArticle ? article.titreArticle : 'Titre de l\'article' }}
                </h4>
                <p class="text-2xl font-bold text-rose-600 mb-3">
                    {{ article is defined and article and article.prixArticle is not null ? (article.prixArticle|number_format(2, ',', ' ')) ~ ' DT' : '-- DT' }}
                </p>
                <div class="flex items-center gap-2 text-sm text-slate-500">
                    <i data-lucide="map-pin" class="w-4 h-4"></i>
                    <span>Marketplace</span>
                </div>
            </div>

            {# Bloc boutons toujours visible (sticky bas) #}
            <div class="flex flex-col gap-3 lg:sticky lg:bottom-6">
                <button type="submit" class="w-full py-3 rounded-xl bg-gradient-to-r from-rose-500 to-pink-600 hover:from-rose-600 hover:to-pink-700 text-white font-medium shadow-lg shadow-rose-500/25 transition-all">
                    {{ mode|default('create') == 'create' ? 'Publier l\'article' : 'Enregistrer' }}
                </button>
                <a href="{{ path('app_admin_marketplace_list') }}" class="w-full py-3 rounded-xl border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-300 font-medium text-center transition-colors">
                    Annuler
                </a>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        (function () {
            const form = document.getElementById('admin-marketplace-form');
            if (!form) return;

            function showNotification(message, type = 'error') {
                const containerId = 'admin-marketplace-notification-container';
                let container = document.getElementById(containerId);
                if (!container) {
                    container = document.createElement('div');
                    container.id = containerId;
                    container.className = 'fixed top-24 right-4 z-50 space-y-2';
                    document.body.appendChild(container);
                }

                const bgClass = type === 'success' ? 'bg-emerald-600' : 'bg-red-600';
                const notif = document.createElement('div');
                notif.className = `${bgClass} text-white px-4 py-3 rounded-xl shadow-lg flex items-start gap-3 border border-white/20`;
                notif.innerHTML = `
                    <div class="mt-0.5">
                        <i data-lucide="${type === 'success' ? 'check-circle' : 'alert-circle'}" class="w-5 h-5"></i>
                    </div>
                    <div class="text-sm">${message}</div>
                `;
                container.appendChild(notif);
                if (window.lucide && typeof window.lucide.createIcons === 'function') {
                    window.lucide.createIcons();
                }

                setTimeout(() => {
                    notif.classList.add('opacity-0');
                    setTimeout(() => notif.remove(), 180);
                }, 3500);
            }

            form.addEventListener('submit', function (e) {
                const data = new FormData(form);
                const errors = [];

                const titre = (data.get('titre') || '').toString().trim();
                const contenu = (data.get('contenu') || '').toString().trim();
                const prixRaw = (data.get('prix') || '').toString().trim();
                const categorie = (data.get('categorie') || '').toString().trim();
                const type = (data.get('type') || '').toString().trim() || 'academic';
                const statut = (data.get('statut') || '').toString().trim() || 'disponible';
                const imageFile = data.get('image');

                if (!titre) {
                    errors.push('Le titre est obligatoire.');
                } else if (titre.length < 2) {
                    errors.push('Le titre doit contenir au moins 2 caracteres.');
                } else if (titre.length > 255) {
                    errors.push('Le titre ne doit pas depasser 255 caracteres.');
                }

                if (!contenu) {
                    errors.push('Le contenu est obligatoire.');
                } else if (contenu.length < 10) {
                    errors.push('Le contenu doit contenir au moins 10 caracteres.');
                } else if (contenu.length > 5000) {
                    errors.push('Le contenu est trop long (max 5000 caracteres).');
                }

                if (!prixRaw) {
                    errors.push('Le prix est obligatoire.');
                } else if (!/^\d+(?:[.,]\d+)?$/.test(prixRaw)) {
                    errors.push('Le prix doit etre un nombre.');
                } else {
                    const prix = parseFloat(prixRaw.replace(',', '.'));
                    if (isNaN(prix) || prix < 0) {
                        errors.push('Le prix doit etre superieur ou egal a 0.');
                    } else if (prix > 1000000) {
                        errors.push('Le prix est trop eleve (max 1 000 000).');
                    }
                }

                if (!categorie) {
                    errors.push('La categorie est obligatoire.');
                } else if (!/^\d+$/.test(categorie)) {
                    errors.push('La categorie selectionnee est invalide.');
                }

                const allowedTypes = ['academic', 'commercial', 'service', 'other'];
                if (type && !allowedTypes.includes(type)) {
                    errors.push('Le type selectionne est invalide.');
                }

                const allowedStatus = ['disponible', 'vendu', 'reserve'];
                if (statut && !allowedStatus.includes(statut)) {
                    errors.push('Le statut selectionne est invalide.');
                }

                if (imageFile && typeof imageFile.name === 'string' && imageFile.name !== '') {
                    const fileName = imageFile.name.toLowerCase();
                    if (!/\.(jpg|jpeg|png|gif|webp)$/.test(fileName)) {
                        errors.push('Le format de l image est invalide (jpg, png, gif, webp).');
                    }
                }

                if (errors.length > 0) {
                    e.preventDefault();
                    errors.forEach((msg) => showNotification(msg, 'error'));
                }
            });
        })();
    </script>
{% endblock %}

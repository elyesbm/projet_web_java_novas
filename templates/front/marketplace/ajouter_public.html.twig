{% extends 'front/base_home.html.twig' %}

{% block title %}Nouvelle Annonce (publique) - Marketplace{% endblock %}

{% block body %}
<div class="min-h-screen bg-background relative overflow-hidden">
    <div class="absolute inset-0 gradient-orb"></div>
    <div class="pt-32 pb-24 px-6">
        <div class="max-w-3xl mx-auto">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-primary/20 mb-4">
                    <i data-lucide="plus-circle" class="w-8 h-8 text-primary"></i>
                </div>
                <h1 class="font-serif text-3xl font-medium mb-2">Ajouter un produit (publique)</h1>
                <p class="text-muted-foreground">Ce formulaire permet d'ajouter un article sans se connecter. L'annonce sera publiée sans auteur.</p>
            </div>

            <form id="marketplace-add-public-form" method="post" action="{{ path('app_marketplace_ajouter_public') }}" enctype="multipart/form-data" class="glass-card rounded-3xl p-8 space-y-6">
                <div>
                    <label class="block text-sm font-medium mb-2 text-muted-foreground">Image (choisir un fichier depuis votre PC)</label>
                    <input type="file" name="image" accept="image/*" class="w-full bg-secondary border border-white/10 rounded-xl px-4 py-2">
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2 text-muted-foreground">Categorie</label>
                    <select name="categorie" class="w-full h-14 bg-secondary border border-white/10 rounded-xl px-4">
                        <option value="">Selectionnez une categorie</option>
                        {% for cat in categories %}
                            <option value="{{ cat.id }}">{{ cat.nom }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2 text-muted-foreground">Titre</label>
                    <input type="text" name="titre" class="w-full h-14 bg-secondary border rounded-xl px-4">
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2 text-muted-foreground">Description</label>
                    <div class="mb-2 flex items-center justify-end">
                        <button
                            type="button"
                            id="btn-generate-description-ai"
                            class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-primary text-white text-sm hover:bg-primary/90 transition-colors"
                        >
                            <i data-lucide="sparkles" class="w-4 h-4"></i>
                            Generer description avec IA
                        </button>
                    </div>
                    <textarea name="contenu" rows="5" class="w-full bg-secondary border rounded-xl p-4 resize-none"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2 text-muted-foreground">Prix (DT)</label>
                    <input type="number" name="prix" class="w-full h-14 bg-secondary border rounded-xl px-4">
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2 text-muted-foreground">Type</label>
                    <select name="type" class="w-full h-14 bg-secondary border rounded-xl px-4">
                        <option value="academic">Academic</option>
                        {# valeur alignée avec les contraintes du contrôleur (#academic, commercial, service, other) #}
                        <option value="commercial">Personal</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2 text-muted-foreground">Statut</label>
                    <select name="statut" class="w-full h-14 bg-secondary border rounded-xl px-4">
                        <option value="disponible">Disponible</option>
                        <option value="reserve">Réservé</option>
                        <option value="vendu">Vendu</option>
                    </select>
                </div>

                <div class="flex gap-4 pt-4">
                    <a href="{{ path('app_marketplace_index') }}" class="flex-1 h-14 bg-secondary border rounded-xl flex items-center justify-center">Annuler</a>
                    <button type="submit" class="flex-1 h-14 bg-primary text-white rounded-xl">Publier (publique)</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        (function () {
            const form = document.getElementById('marketplace-add-public-form');
            if (!form) return;

            function showNotification(message, type = 'error') {
                const containerId = 'marketplace-notification-container';
                let container = document.getElementById(containerId);
                if (!container) {
                    container = document.createElement('div');
                    container.id = containerId;
                    container.className = 'fixed top-24 right-4 z-50 space-y-2';
                    document.body.appendChild(container);
                }

                const bgClass = type === 'success' ? 'bg-emerald-600' : 'bg-red-600';
                const borderClass = type === 'success' ? 'border-emerald-400/60' : 'border-red-400/60';

                const notif = document.createElement('div');
                notif.className = `glass-card ${bgClass} border ${borderClass} text-white px-4 py-3 rounded-2xl shadow-lg flex items-start gap-3 animate-fade-in`;
                notif.innerHTML = `
                    <div class="mt-0.5">
                        <i data-lucide="${type === 'success' ? 'check-circle' : 'alert-circle'}" class="w-5 h-5"></i>
                    </div>
                    <div class="text-sm">${message}</div>
                `;
                container.appendChild(notif);
                if (window.lucide && typeof window.lucide.createIcons === 'function') {
                    window.lucide.createIcons();
                }

                setTimeout(() => {
                    notif.classList.add('opacity-0', 'translate-y-1');
                    setTimeout(() => notif.remove(), 200);
                }, 3500);
            }

            form.addEventListener('submit', function (e) {
                const data = new FormData(form);
                const errors = [];

                const titre = (data.get('titre') || '').toString().trim();
                const contenu = (data.get('contenu') || '').toString().trim();
                const prixRaw = (data.get('prix') || '').toString().trim();
                const categorie = (data.get('categorie') || '').toString().trim();
                const type = (data.get('type') || '').toString().trim() || 'academic';
                const statut = (data.get('statut') || '').toString().trim() || 'disponible';

                // Titre
                if (!titre) {
                    errors.push('Le titre est obligatoire.');
                } else if (titre.length < 2) {
                    errors.push('Le titre doit contenir au moins 2 caractères.');
                } else if (titre.length > 255) {
                    errors.push('Le titre ne doit pas dépasser 255 caractères.');
                }

                // Contenu
                if (!contenu) {
                    errors.push('Le contenu est obligatoire.');
                } else if (contenu.length < 10) {
                    errors.push('Le contenu doit contenir au moins 10 caractères.');
                } else if (contenu.length > 5000) {
                    errors.push('Le contenu est trop long (max 5000 caractères).');
                }

                // Prix
                if (!prixRaw) {
                    errors.push('Le prix est obligatoire.');
                } else if (!/^\d+(?:[.,]\d+)?$/.test(prixRaw)) {
                    errors.push('Le prix doit être un nombre.');
                } else {
                    const prix = parseFloat(prixRaw.replace(',', '.'));
                    if (isNaN(prix) || prix < 0) {
                        errors.push('Le prix doit être supérieur ou égal à 0.');
                    } else if (prix > 1000000) {
                        errors.push('Le prix est trop élevé (max 1 000 000).');
                    }
                }

                // Catégorie
                if (!categorie) {
                    errors.push('La catégorie est obligatoire.');
                } else if (!/^\d+$/.test(categorie)) {
                    errors.push('La catégorie sélectionnée est invalide.');
                }

                // Type
                const allowedTypes = ['academic', 'commercial', 'service', 'other'];
                if (type && !allowedTypes.includes(type)) {
                    errors.push('Le type sélectionné est invalide.');
                }

                // Statut
                const allowedStatus = ['disponible', 'vendu', 'reserve'];
                if (statut && !allowedStatus.includes(statut)) {
                    errors.push('Le statut sélectionné est invalide.');
                }

                if (errors.length > 0) {
                    e.preventDefault();
                    errors.forEach(msg => showNotification(msg, 'error'));
                }
            });

            const generateBtn = document.getElementById('btn-generate-description-ai');
            const titleInput = form.querySelector('input[name="titre"]');
            const categorySelect = form.querySelector('select[name="categorie"]');
            const typeSelect = form.querySelector('select[name="type"]');
            const priceInput = form.querySelector('input[name="prix"]');
            const descriptionInput = form.querySelector('textarea[name="contenu"]');

            if (generateBtn && titleInput && categorySelect && typeSelect && priceInput && descriptionInput) {
                const defaultBtnText = generateBtn.innerHTML;
                generateBtn.addEventListener('click', async function () {
                    const titre = (titleInput.value || '').trim();
                    if (!titre) {
                        showNotification('Le titre est obligatoire pour generer une description.', 'error');
                        titleInput.focus();
                        return;
                    }

                    const categorieLabel = categorySelect.options[categorySelect.selectedIndex]
                        ? categorySelect.options[categorySelect.selectedIndex].text
                        : '';
                    const type = (typeSelect.value || '').trim();
                    const prix = (priceInput.value || '').toString().trim();

                    generateBtn.disabled = true;
                    generateBtn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Generation...';
                    if (window.lucide && typeof window.lucide.createIcons === 'function') {
                        window.lucide.createIcons();
                    }

                    try {
                        const response = await fetch('{{ path('app_marketplace_ai_generate_description') }}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            body: JSON.stringify({
                                _token: '{{ csrf_token('marketplace_ai_generate_description') }}',
                                titre: titre,
                                categorie: categorieLabel,
                                type: type,
                                prix: prix
                            })
                        });

                        const data = await response.json();
                        if (!response.ok) {
                            throw new Error(data.error || 'Erreur de generation IA.');
                        }

                        descriptionInput.value = (data.description || '').trim();
                        showNotification('Description generee avec succes.', 'success');
                    } catch (err) {
                        showNotification(err.message || 'Erreur lors de la generation IA.', 'error');
                    } finally {
                        generateBtn.disabled = false;
                        generateBtn.innerHTML = defaultBtnText;
                        if (window.lucide && typeof window.lucide.createIcons === 'function') {
                            window.lucide.createIcons();
                        }
                    }
                });
            }
        })();
    </script>
{% endblock %}
